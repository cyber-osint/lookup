<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>🕵️‍♂️ Cyber OSINT Search</title>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 min-h-screen flex font-sans text-gray-200 overflow-x-hidden">

  <!-- 좌측: 검색 이력 -->
  <aside class="w-64 bg-gray-800 border-r border-gray-700 p-4 hidden md:block">
    <h2 class="text-lg font-semibold mb-4 text-gray-300 border-b border-gray-700 pb-2">📜 검색 이력</h2>
    <ul id="historyList" class="space-y-2 text-sm text-blue-400 cursor-pointer"></ul>
    <button onclick="clearHistory()" class="mt-4 text-xs text-red-400 hover:underline">이력 전체 삭제</button>
  </aside>

  <!-- 우측: 메인 콘텐츠 -->
  <main class="flex-1 flex flex-col items-center justify-start sm:pt-12 md:pt-24 sm:px-4 md:px-6 w-full">
    <div class="text-center mb-8">
      <h1 class="text-4xl font-semibold text-white">🕵️‍♂️Cyber OSINT</h1>
      <p class="text-sm text-gray-400 mt-2">🔍IP / 도메인 기반 OSINT 검색 엔진</p>
    </div>

    <!-- 검색창 -->
    <div class="w-full max-w-xl">
      <div class="flex items-center shadow-xl rounded-full border border-blue-700 overflow-hidden">
        <input
          id="input"
          type="text"
          placeholder="도메인 또는 IP 입력 (예: google.com, 8.8.8.8)"
          class="w-full px-6 py-3 text-base bg-gray-700 text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
        />
        <button
          onclick="fetchData()"
          class="bg-gray-700 hover:bg-gray-600 text-white px-6 py-3 text-sm font-semibold transition focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-gray-900 flex items-center justify-center gap-2"
        >
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
          </svg>
          Search
        </button>
      </div>
    </div>

    <!-- 결과 -->
    <div id="result" class="w-full max-w-3xl mt-10 space-y-6"></div>
  </main>

  <script>
    document.addEventListener("DOMContentLoaded", loadHistory);
    document.getElementById('input').addEventListener('keypress', function (e) {
      if (e.key === 'Enter') fetchData();
    });

    function saveToHistory(query) {
      let history = JSON.parse(localStorage.getItem('osint_history') || '[]');
      history = history.filter(item => item !== query);
      history.unshift(query);
      if (history.length > 20) history.pop();
      localStorage.setItem('osint_history', JSON.stringify(history));
      loadHistory();
    }

    function loadHistory() {
      const historyList = document.getElementById('historyList');
      const history = JSON.parse(localStorage.getItem('osint_history') || '[]');
      historyList.innerHTML = history.map(item => `
        <li onclick="searchFromHistory('${item}')" class="hover:text-blue-200">${item}</li>
      `).join('');
    }

    function clearHistory() {
      localStorage.removeItem('osint_history');
      loadHistory();
    }

    function searchFromHistory(query) {
      document.getElementById('input').value = query;
      fetchData();
    }

    async function resolveDomain(domain) {
      const res = await axios.get(`https://dns.google/resolve?name=${domain}&type=A`);
      const answers = res.data.Answer || [];
      const ipAnswer = answers.reverse().find(a => a.type === 1);
      if (!ipAnswer) throw new Error("IP 주소를 찾을 수 없습니다.");
      return ipAnswer.data;
    }

    async function fetchData() {
      const input = document.getElementById('input').value.trim();
      const resultEl = document.getElementById('result');
      resultEl.innerHTML = '<div class="text-gray-400 text-sm">🔄 검색 중...</div>';

      if (!input) {
        resultEl.innerHTML = '<div class="text-red-400 text-sm">⚠ 검색어를 입력해주세요.</div>';
        return;
      }

      try {
        saveToHistory(input);
        let ip = input;
        const isDomain = isNaN(Number(input.split('.')[0]));
        if (isDomain) ip = await resolveDomain(input);

        const [shodanRes, ipinfoRes] = await Promise.all([
          axios.get(`https://internetdb.shodan.io/${ip}`),
          axios.get(`https://ipinfo.io/${ip}/json`)
        ]);

        const data = {
          ...shodanRes.data,
          resolvedIp: ip,
          country: ipinfoRes.data.country || '',
          org: ipinfoRes.data.org || '',
          city: ipinfoRes.data.city || '',
          region: ipinfoRes.data.region || '',
          timezone: ipinfoRes.data.timezone || '',
        };

        let subdomainsHtml = '';
        if (isDomain) {
          subdomainsHtml = await fetchSubdomains(input);
        }

        resultEl.innerHTML = `
          <div class="bg-gray-800 rounded-lg p-6 shadow-xl border border-blue-700">
            <div class="text-xl font-semibold mb-4 text-white">💡 ${input} 검색 결과</div>
            ${renderSection('호스트네임', data.hostnames)}
            ${renderSection('IP 주소', [ip], '🌐')}
            ${renderSection('포트', data.ports, '🔌')}
            ${renderListSection('CPE 목록', data.cpes)}
            ${renderSection('⚠️ 취약점', data.vulns, '', 'bg-red-700 text-red-200')}
            ${renderSection('🏷️ 태그', data.tags, '#')}
            ${renderJaFingerprints(data)}
            ${renderIpinfoSection(data)}
            ${subdomainsHtml}
            ${renderBGPImage(ip)}
          </div>
        `;

        if (isDomain) {
          const certBox = document.createElement('div');
          certBox.id = 'crtsh';
          certBox.innerHTML = `<div class="text-sm text-gray-400">📄 인증서 정보 불러오는 중...</div>`;
          resultEl.appendChild(certBox);
          fetchCrtshData(input);
        }

      } catch (e) {
        resultEl.innerHTML = `<div class="text-red-400 text-sm font-medium">⚠ ${e.message}</div>`;
      }
    }

    async function fetchSubdomains(domain) {
      try {
        const res = await axios.get(`https://api.certspotter.com/v1/issuances?domain=${domain}&include_subdomains=true&expand=dns_names`);
        const rawDnsNames = res.data.flatMap(entry => entry.dns_names);
        const unique = [...new Set(rawDnsNames)].sort();
        return renderSection('🔸 서브도메인', unique);
      } catch {
        return `<div class="text-red-400 text-sm">⚠ 서브도메인 정보를 불러올 수 없습니다.</div>`;
      }
    }

    async function fetchCrtshData(domain) {
      try {
        const res = await axios.get(`https://crt.sh/?q=${domain}&output=json`);
        const certs = res.data.slice(0, 5);
        document.getElementById('crtsh').innerHTML = renderCertsSection(certs);
      } catch {
        document.getElementById('crtsh').innerHTML =
          `<div class="text-red-400 text-sm">⚠ 인증서 정보를 불러올 수 없습니다.</div>`;
      }
    }

    function renderSection(title, items = [], prefix = '', badgeClass = 'bg-gray-700 text-gray-200') {
      if (!items || items.length === 0) return '';
      return `
        <div class="mb-4">
          <div class="text-gray-400 font-medium mb-1">${title}</div>
          <div class="flex flex-wrap gap-2">
            ${items.map(i => `<span class="text-xs px-2 py-1 rounded-full ${badgeClass}">${prefix} ${i}</span>`).join('')}
          </div>
        </div>
      `;
    }

    function renderListSection(title, items = []) {
      if (!items || items.length === 0) return '';
      return `
        <div class="mb-4">
          <div class="text-gray-400 font-medium mb-1">${title}</div>
          <ul class="list-disc ml-5 text-sm text-gray-400 space-y-1">
            ${items.map(i => `<li>${i}</li>`).join('')}
          </ul>
        </div>
      `;
    }

    function renderJaFingerprints(data) {
      if (!data.ja3 && !data.ja3s && !data.ja4 && !data.ja4s) return '';
      return `
        <div class="mb-4">
          <div class="text-gray-400 font-medium mb-1">🔐 TLS 핑거프린트</div>
          <div class="space-y-1 text-sm text-gray-400">
            ${data.ja3 ? `<div><strong>JA3:</strong> ${data.ja3}</div>` : ''}
            ${data.ja3s ? `<div><strong>JA3S:</strong> ${data.ja3s}</div>` : ''}
            ${data.ja4 ? `<div><strong>JA4:</strong> ${data.ja4}</div>` : ''}
            ${data.ja4s ? `<div><strong>JA4S:</strong> ${data.ja4s}</div>` : ''}
          </div>
        </div>
      `;
    }

    function renderIpinfoSection(data) {
      if (!data.country && !data.org && !data.city && !data.region && !data.timezone) return '';
      return `
        <div class="mb-4">
          <div class="text-gray-400 font-medium mb-1">📍 네트워크 정보</div>
          <div class="text-sm text-gray-400 space-y-1">
            ${data.country ? `<div><strong>국가:</strong> ${data.country}</div>` : ''}
            ${data.region ? `<div><strong>지역:</strong> ${data.region}</div>` : ''}
            ${data.city ? `<div><strong>도시:</strong> ${data.city}</div>` : ''}
            ${data.timezone ? `<div><strong>타임존:</strong> ${data.timezone}</div>` : ''}
            ${data.org ? `<div><strong>ASN:</strong> ${data.org}</div>` : ''}
          </div>
        </div>
      `;
    }

    function renderBGPImage(ip) {
      return `
        <div class="mt-6 hidden md:block">
          <div class="text-gray-400 font-medium mb-2">📡 BGP Path (bgp.tools)</div>
          <div class="overflow-auto max-w-[600px]">
            <img
              src="https://bgp.tools/pathimg/rt-${ip}_24"
              alt="BGP path for ${ip}"
              class="rounded-lg border border-gray-700 shadow-md max-w-full"
              onerror="this.parentElement.innerHTML='<div class=\'text-red-400 text-sm\'>⚠ BGP 경로 이미지를 불러올 수 없습니다.</div>'"
            />
          </div>
        </div>
      `;
    }

    function renderCertsSection(certs = []) {
      if (!certs || certs.length === 0) return '<div class="text-sm text-gray-400">표시할 인증서 정보가 없습니다.</div>';
      return `
        <div class="mt-4 space-y-4">
          <div class="text-gray-400 font-medium">📄 인증서 정보 (crt.sh)</div>
          ${certs.map(cert => `
            <div class="p-3 border rounded-md bg-gray-800 shadow-sm text-xs space-y-1 text-gray-400">
              <div><strong>📛 Common Name:</strong> ${cert.common_name}</div>
              <div><strong>📥 Name Value:</strong> ${cert.name_value.replace(/\n/g, ', ')}</div>
              <div><strong>🏢 Issuer:</strong> ${cert.issuer_name}</div>
              <div><strong>🕓 등록:</strong> ${cert.entry_timestamp}</div>
              <div><strong>✅ 유효기간:</strong> ${cert.not_before} ~ ${cert.not_after}</div>
            </div>
          `).join('')}
        </div>
      `;
    }
  </script>
</body>
</html>
